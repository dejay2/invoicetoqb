<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Tools</title>
  <link rel="stylesheet" href="styles.css?v=20241010" />
</head>
<body>
  <main class="container">
    <header>
      <h1>Invoice Toolkit</h1>
      <p>Choose a company to manage QuickBooks connections, reference data, and parsed invoices.</p>
    </header>

    <section id="global-status" class="status" hidden></section>

    <section class="selector-card">
      <div class="selector-field">
        <label for="company-select">Select a company</label>
        <select id="company-select" name="company">
          <option value="">Choose a company</option>
        </select>
      </div>
      <button id="add-company" type="button" class="primary-button">Add Company</button>
    </section>

    <section id="company-dashboard" class="company-dashboard" hidden>
      <nav class="tabs company-tabs" role="tablist">
        <button class="tab active" data-company-tab="company-settings" role="tab" aria-selected="true" aria-controls="company-settings">Company settings</button>
        <button class="tab" data-company-tab="add-invoices" role="tab" aria-selected="false" aria-controls="add-invoices">Add invoices / bills</button>
        <button class="tab" data-company-tab="vendor-settings" role="tab" aria-selected="false" aria-controls="vendor-settings">Vendor settings</button>
        <button class="tab" data-company-tab="account-settings" role="tab" aria-selected="false" aria-controls="account-settings">Account / category settings</button>
        <button class="tab" data-company-tab="to-review" role="tab" aria-selected="false" aria-controls="to-review">To review</button>
        <button class="tab" data-company-tab="archive" role="tab" aria-selected="false" aria-controls="archive">Archive</button>
      </nav>

      <section id="company-settings" class="company-panel active" role="tabpanel">
        <div class="panel-card">
          <h2>Connection</h2>
          <p id="connection-status" class="panel-summary">Select a company to view connection details.</p>
          <div class="panel-actions">
            <button id="connect-company" type="button" class="primary-button">Connect / Reconnect to QuickBooks</button>
            <button id="refresh-metadata" type="button" class="secondary-button">Refresh QuickBooks Data</button>
          </div>
        </div>
        <div class="panel-card">
          <h2>Business profile</h2>
          <p class="panel-summary">Share a short description of the business to guide AI account suggestions.</p>
          <form id="business-profile-form" class="company-edit-form">
            <div class="input-group">
              <label for="company-business-type">Business type</label>
              <input id="company-business-type" name="businessType" type="text" placeholder="e.g., Restaurant, Construction contractor" maxlength="120" />
            </div>
            <button id="business-profile-submit" type="submit" class="primary-button">Save profile</button>
          </form>
        </div>
        <div class="panel-card">
          <h2>OneDrive automation</h2>
          <p class="panel-summary">Monitor a OneDrive folder and import new invoices automatically for this company.</p>
          <form id="onedrive-settings-form" class="onedrive-form">
            <div class="input-group">
              <label for="onedrive-share-url">Sharing link (optional)</label>
              <input id="onedrive-share-url" name="shareUrl" type="url" placeholder="https://onedrive.live.com/..." autocomplete="off" />
              <span>Provide a sharing link or specify the Drive and folder details below.</span>
            </div>
            <div class="form-divider"><span>or</span></div>
            <div class="input-row">
              <div class="input-group">
                <label for="onedrive-drive-id">Drive ID</label>
                <input id="onedrive-drive-id" name="driveId" type="text" autocomplete="off" />
              </div>
              <div class="input-group">
                <label for="onedrive-folder-id">Folder ID</label>
                <input id="onedrive-folder-id" name="folderId" type="text" autocomplete="off" />
              </div>
            </div>
            <div class="input-group">
              <label for="onedrive-folder-path">Folder path (optional)</label>
              <input id="onedrive-folder-path" name="folderPath" type="text" placeholder="/Invoices/Incoming" autocomplete="off" />
              <span>Use when the folder ID is unknown. The path is relative to the drive root.</span>
            </div>
            <label class="checkbox-group">
              <input id="onedrive-enabled" name="enabled" type="checkbox" />
              <span>Enable automatic imports from this folder</span>
            </label>
            <div class="onedrive-actions">
              <button type="submit" id="onedrive-save" class="primary-button">Save OneDrive settings</button>
              <button type="button" id="onedrive-sync-now" class="secondary-button">Sync now</button>
              <button type="button" id="onedrive-resync" class="secondary-button">Full resync</button>
              <button type="button" id="onedrive-clear" class="danger-button">Disconnect</button>
            </div>
          </form>
          <dl class="onedrive-status" id="onedrive-status" hidden>
            <div>
              <dt>Status</dt>
              <dd id="onedrive-status-state">Not connected</dd>
            </div>
            <div>
              <dt>Folder</dt>
              <dd id="onedrive-status-folder">—</dd>
            </div>
            <div>
              <dt>Last sync</dt>
              <dd id="onedrive-status-last-sync">—</dd>
            </div>
            <div>
              <dt>Last result</dt>
              <dd id="onedrive-status-result">—</dd>
            </div>
            <div>
              <dt>Activity log</dt>
              <dd id="onedrive-status-log">—</dd>
            </div>
          </dl>
        </div>
        <div class="panel-card">
          <h2>Gmail inbox monitoring</h2>
          <p class="panel-summary">Connect a Gmail mailbox to watch for new invoice attachments and ingest them automatically.</p>
          <form id="gmail-settings-form" class="gmail-form">
            <div class="input-group">
              <label for="gmail-email">Mailbox email address</label>
              <input id="gmail-email" name="email" type="email" placeholder="accounts@yourcompany.com" autocomplete="off" />
              <span>The connected Google account should have access to the inbox you want to monitor.</span>
            </div>
            <div class="input-group">
              <label for="gmail-search-query">Search query</label>
              <input id="gmail-search-query" name="searchQuery" type="text" placeholder="in:inbox has:attachment" autocomplete="off" />
              <span>Uses Gmail search syntax to limit which messages are processed. Leave blank to use the default.</span>
            </div>
            <div class="input-group">
              <label for="gmail-label-ids">Label filters (optional)</label>
              <input id="gmail-label-ids" name="labelIds" type="text" placeholder="INBOX,Finance" autocomplete="off" />
              <span>Comma-separated label IDs or names. Leave blank to include all labels.</span>
            </div>
            <div class="input-group">
              <label for="gmail-mime-types">Allowed MIME types</label>
              <input id="gmail-mime-types" name="allowedMimeTypes" type="text" placeholder="application/pdf,image/png,image/jpeg" autocomplete="off" />
              <span>Comma-separated list. Attachments with other types are skipped.</span>
            </div>
            <div class="input-group">
              <label for="gmail-poll-interval">Polling interval (seconds)</label>
              <input id="gmail-poll-interval" name="pollInterval" type="number" min="15" step="15" autocomplete="off" />
            </div>
            <label class="checkbox-group">
              <input id="gmail-enabled" name="enabled" type="checkbox" />
              <span>Enable automatic imports from this mailbox</span>
            </label>
            <div class="gmail-actions">
              <button type="button" id="gmail-connect" class="primary-button">Connect Gmail inbox</button>
              <button type="submit" id="gmail-save" class="primary-button">Save Gmail settings</button>
              <button type="button" id="gmail-sync-now" class="secondary-button">Sync now</button>
              <button type="button" id="gmail-disconnect" class="danger-button">Disconnect</button>
            </div>
          </form>
          <dl class="gmail-status" id="gmail-status" hidden>
            <div>
              <dt>Status</dt>
              <dd id="gmail-status-state">Not connected</dd>
            </div>
            <div>
              <dt>Mailbox</dt>
              <dd id="gmail-status-email">—</dd>
            </div>
            <div>
              <dt>Last sync</dt>
              <dd id="gmail-status-last-sync">—</dd>
            </div>
            <div>
              <dt>Last result</dt>
              <dd id="gmail-status-result">—</dd>
            </div>
          </dl>
        </div>
      </section>

      <section id="add-invoices" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Add invoices or bills</h2>
          <p class="panel-summary">Drag and drop files or click the surface below to select multiple invoices at once. Parsed results are routed to the To Review tab.</p>
          <div id="invoice-drop-zone" class="drop-zone" role="button" tabindex="0">
            <input id="invoice-upload-input" class="visually-hidden" type="file" accept=".pdf,.png,.jpg,.jpeg,.heic,.tif,.tiff,.txt,.doc,.docx,.json,.xml" multiple />
            <div class="drop-zone-content">
              <p class="drop-zone-title">Drag and drop files here</p>
              <p class="drop-zone-subtitle">or click to add file(s)</p>
            </div>
          </div>
          <ul id="upload-status-list" class="upload-status-list">
            <li class="empty">No uploads yet.</li>
          </ul>
        </div>
      </section>

      <section id="vendor-settings" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Vendors</h2>
          <div class="panel-toolbar">
            <button id="import-vendor-defaults" type="button" class="secondary-button">Import suggested defaults</button>
          </div>
          <ul id="vendor-list" class="entity-list">
            <li class="empty">Select a company to load vendor details.</li>
          </ul>
        </div>
      </section>

      <section id="account-settings" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Accounts &amp; Categories</h2>
          <ul id="account-list" class="entity-list">
            <li class="empty">Select a company to load account details.</li>
          </ul>
        </div>
      </section>

      <section id="to-review" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>To Review</h2>
          <p class="panel-summary">Invoices awaiting manual checks before export are listed below.</p>
          <div id="review-bulk-actions" class="review-bulk-actions" hidden>
            <span id="review-selection-count" class="bulk-selection-count">No invoices selected.</span>
            <div class="review-bulk-buttons">
              <button type="button" id="review-bulk-archive" class="bulk-action" disabled>Move selected to archive</button>
              <button type="button" id="review-bulk-delete" class="bulk-action destructive" disabled>Delete selected</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="review-table">
              <thead>
                <tr>
                  <th scope="col" class="col-select">
                    <input type="checkbox" id="review-select-all" aria-label="Select all invoices awaiting review" />
                  </th>
                  <th scope="col">Invoice</th>
                  <th scope="col">Invoice date</th>
                  <th scope="col">Vendor</th>
                  <th scope="col">Account</th>
                  <th scope="col">Tax code</th>
                  <th scope="col">Total ex VAT</th>
                  <th scope="col">VAT</th>
                  <th scope="col">Grand total</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="review-table-body">
                <tr class="empty-row">
                  <td colspan="10">No invoices pending review.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="archive" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Archive</h2>
          <p class="panel-summary">Invoices parsed with Gemini are stored here until they are moved for review or removed.</p>
          <div class="table-wrapper">
            <table class="archive-table">
              <thead>
                <tr>
                  <th scope="col">Invoice</th>
                  <th scope="col">Vendor</th>
                  <th scope="col">Invoice date</th>
                  <th scope="col">Total</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="archive-table-body">
                <tr class="empty-row">
                  <td colspan="5">No archived invoices yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div id="qb-preview-modal" class="modal" hidden aria-hidden="true">
    <div class="modal-overlay" data-modal-dismiss></div>
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="qb-preview-title">
      <header class="modal-header">
        <h2 id="qb-preview-title">QuickBooks Preview</h2>
        <button type="button" id="qb-preview-dismiss" class="icon-button" aria-label="Close preview">&times;</button>
      </header>
      <div class="modal-body">
        <div class="modal-meta">
          <span id="qb-preview-method" class="modal-method">—</span>
        </div>
        <div id="qb-preview-summary" class="preview-summary" hidden></div>
        <pre class="code-block"><code id="qb-preview-json"></code></pre>
      </div>
      <footer class="modal-footer">
        <button type="button" id="qb-preview-copy" class="secondary-button">Copy JSON</button>
        <button type="button" id="qb-preview-close" class="primary-button">Close</button>
      </footer>
    </div>
  </div>

  <script src="app.js?v=20241216" defer></script>
</body>
</html>
