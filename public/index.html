<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Tools</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css?v=20241010" />
</head>
<body>
  <main class="container">
    <header>
      <h1>Invoice Toolkit</h1>
      <p>Choose a company to manage QuickBooks connections, reference data, and parsed invoices.</p>
    </header>

    <section id="global-status" class="status" hidden></section>

    <section class="selector-card">
      <div class="selector-field">
        <label for="company-select">Select a company</label>
        <select id="company-select" name="company">
          <option value="">Choose a company</option>
        </select>
      </div>
      <button id="add-company" type="button" class="primary-button">Add Company</button>
    </section>

    <section id="company-dashboard" class="company-dashboard" hidden>
      <nav class="tabs company-tabs" role="tablist">
        <button class="tab active" data-company-tab="company-settings" role="tab" aria-selected="true" aria-controls="company-settings">Company settings</button>
        <button class="tab" data-company-tab="add-invoices" role="tab" aria-selected="false" aria-controls="add-invoices">Add invoices / bills</button>
        <button class="tab" data-company-tab="vendor-settings" role="tab" aria-selected="false" aria-controls="vendor-settings">Vendor settings</button>
        <button class="tab" data-company-tab="account-settings" role="tab" aria-selected="false" aria-controls="account-settings">Account / category settings</button>
        <button class="tab" data-company-tab="to-review" role="tab" aria-selected="false" aria-controls="to-review">To review</button>
        <button class="tab" data-company-tab="archive" role="tab" aria-selected="false" aria-controls="archive">Archive</button>
      </nav>

      <section id="company-settings" class="company-panel active" role="tabpanel">
        <div class="panel-card">
          <h2>Connection</h2>
          <p id="connection-status" class="panel-summary">Select a company to view connection details.</p>
          <div class="panel-actions">
            <button id="connect-company" type="button" class="primary-button">Connect / Reconnect to QuickBooks</button>
            <button id="refresh-metadata" type="button" class="secondary-button">Refresh QuickBooks Data</button>
          </div>
        </div>
        <div class="panel-card">
          <h2>Business profile</h2>
          <p class="panel-summary">Share a short description of the business to guide AI account suggestions.</p>
          <form id="business-profile-form" class="company-edit-form">
            <div class="input-group">
              <label for="company-business-type">Business type</label>
              <input id="company-business-type" name="businessType" type="text" placeholder="e.g., Restaurant, Construction contractor" maxlength="120" />
            </div>
            <button id="business-profile-submit" type="submit" class="primary-button">Save profile</button>
          </form>
        </div>
        <div class="panel-card">
          <h2>OneDrive automation</h2>
          <p class="panel-summary">Monitor a OneDrive folder and import new invoices automatically for this company.</p>
          <section class="onedrive-shared-card" aria-labelledby="onedrive-shared-heading">
            <div class="onedrive-shared-row">
              <div class="onedrive-shared-heading">
                <h3 id="onedrive-shared-heading">OneDrive account</h3>
                <span id="onedrive-shared-status" class="status-pill status-pill--muted">Not connected</span>
              </div>
              <div class="onedrive-shared-actions">
                <button type="button" id="onedrive-shared-connect" class="secondary-button">Connect OneDrive account</button>
                <button type="button" id="onedrive-shared-validate" class="secondary-button" disabled>Run connection check</button>
              </div>
            </div>
            <p id="onedrive-shared-summary-text" class="onedrive-shared-summary">Connect the OneDrive account that stores your invoice folders. Each company can choose its own monitored and processed folders below.</p>
            <dl class="onedrive-shared-meta">
              <div>
                <dt>Last validated</dt>
                <dd id="onedrive-shared-last-validated">Never</dd>
              </div>
              <div>
                <dt>Status</dt>
                <dd id="onedrive-shared-last-result">No checks yet.</dd>
              </div>
            </dl>
          </section>
          <form id="onedrive-settings-form" class="onedrive-form">
            <div class="onedrive-field-group">
              <div class="onedrive-summary">
                <h3>Monitored folder</h3>
                <p id="onedrive-monitored-summary" class="onedrive-summary-text">No folder selected.</p>
              </div>
              <div class="onedrive-selector-actions">
                <button type="button" id="onedrive-browse-monitored" class="secondary-button" disabled>Select folder</button>
              </div>
            </div>
            <div class="onedrive-field-group">
              <div class="onedrive-summary">
                <h3>Processed folder</h3>
                <p id="onedrive-processed-summary" class="onedrive-summary-text">Processed invoices will move into a “Synced” folder inside the monitored location.</p>
              </div>
              <div class="onedrive-selector-actions">
                <button type="button" id="onedrive-browse-processed" class="secondary-button" disabled>Select processed folder</button>
                <button type="button" id="onedrive-processed-clear" class="ghost-button">Clear</button>
              </div>
            </div>
            <label class="checkbox-group">
              <input id="onedrive-enabled" name="enabled" type="checkbox" />
              <span>Enable automatic imports from this folder</span>
            </label>
            <input id="onedrive-folder-id" name="folderId" type="hidden" />
            <input id="onedrive-folder-path" name="folderPath" type="hidden" />
            <input id="onedrive-folder-name" name="folderName" type="hidden" />
            <input id="onedrive-folder-weburl" name="folderWebUrl" type="hidden" />
            <input id="onedrive-folder-parent-id" name="folderParentId" type="hidden" />
            <input id="onedrive-processed-folder-id" name="processedFolderId" type="hidden" />
            <input id="onedrive-processed-folder-path" name="processedFolderPath" type="hidden" />
            <input id="onedrive-processed-folder-name" name="processedFolderName" type="hidden" />
            <input id="onedrive-processed-folder-weburl" name="processedFolderWebUrl" type="hidden" />
            <input id="onedrive-processed-folder-parent-id" name="processedFolderParentId" type="hidden" />
            <div class="onedrive-actions">
              <button type="submit" id="onedrive-save" class="primary-button">Save OneDrive settings</button>
              <button type="button" id="onedrive-sync-now" class="secondary-button">Sync now</button>
              <button type="button" id="onedrive-resync" class="secondary-button">Request full resync</button>
              <button type="button" id="onedrive-clear" class="danger-button">Disconnect OneDrive</button>
            </div>
            <dl class="onedrive-status" id="onedrive-status" hidden>
              <div>
                <dt>Status</dt>
                <dd id="onedrive-status-state">Not connected</dd>
              </div>
              <div>
                <dt>Folder</dt>
                <dd id="onedrive-status-folder">—</dd>
              </div>
              <div>
                <dt>Last sync</dt>
                <dd id="onedrive-status-last-sync">—</dd>
              </div>
              <div>
                <dt>Last result</dt>
                <dd id="onedrive-status-result">—</dd>
              </div>
              <div>
                <dt>Activity log</dt>
                <dd id="onedrive-status-log">—</dd>
              </div>
            </dl>
          </form>
        </div>
        <div class="panel-card">
          <h2>Outlook mailbox monitoring</h2>
          <p class="panel-summary">Monitor a shared Outlook mailbox folder and import new invoice attachments automatically.</p>
          <section class="outlook-shared-card" aria-labelledby="outlook-shared-heading">
            <div class="outlook-shared-row">
              <div class="outlook-shared-heading">
                <h3 id="outlook-shared-heading">Shared mailbox</h3>
                <span id="outlook-shared-status" class="status-pill status-pill--muted">Unconfigured</span>
              </div>
              <div class="outlook-shared-actions">
                <button type="button" id="outlook-shared-edit" class="secondary-button">Configure mailbox</button>
              </div>
            </div>
            <p id="outlook-shared-summary-text" class="outlook-shared-summary">Shared Outlook mailbox is not configured yet.</p>
            <dl class="outlook-shared-meta">
              <div>
                <dt>Mailbox</dt>
                <dd id="outlook-shared-mailbox">—</dd>
              </div>
              <div>
                <dt>Base folder</dt>
                <dd id="outlook-shared-base-folder">—</dd>
              </div>
              <div>
                <dt>Last validation</dt>
                <dd id="outlook-shared-last-validated">Never</dd>
              </div>
            </dl>
            <form id="outlook-shared-form" class="outlook-shared-form" hidden>
              <div class="input-group">
                <label for="outlook-shared-mailbox-input">Mailbox user ID or UPN</label>
                <input id="outlook-shared-mailbox-input" name="mailboxUserId" type="text" autocomplete="off" placeholder="invoices@contoso.com" />
                <span>Provide the Exchange Online shared mailbox identifier or user principal name.</span>
              </div>
              <div class="input-group">
                <label for="outlook-shared-display-name">Display name (optional)</label>
                <input id="outlook-shared-display-name" name="mailboxDisplayName" type="text" autocomplete="off" />
              </div>
              <div class="outlook-shared-form-footer">
                <button type="button" id="outlook-shared-browse-base" class="secondary-button">Choose base folder</button>
                <div class="outlook-shared-form-actions">
                  <button type="button" id="outlook-shared-cancel" class="ghost-button">Cancel</button>
                  <button type="submit" id="outlook-shared-save" class="primary-button">Save mailbox</button>
                </div>
              </div>
              <input id="outlook-shared-base-id" name="baseFolderId" type="hidden" />
              <input id="outlook-shared-base-path" name="baseFolderPath" type="hidden" />
              <input id="outlook-shared-base-name" name="baseFolderName" type="hidden" />
              <input id="outlook-shared-base-weburl" name="baseFolderWebUrl" type="hidden" />
            </form>
          </section>
          <form id="outlook-settings-form" class="outlook-form">
            <div class="outlook-field-group">
              <div class="outlook-summary">
                <h3>Monitored folder</h3>
                <p id="outlook-folder-summary" class="outlook-summary-text">No folder selected.</p>
              </div>
              <div class="outlook-selector-actions">
                <button type="button" id="outlook-browse-folder" class="secondary-button" disabled>Select folder</button>
                <button type="button" id="outlook-clear-folder" class="ghost-button">Clear</button>
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label for="outlook-poll-interval">Polling interval (seconds)</label>
                <input id="outlook-poll-interval" name="pollInterval" type="number" min="15" step="15" autocomplete="off" />
              </div>
              <div class="input-group">
                <label for="outlook-max-attachment">Attachment size limit (MB)</label>
                <input id="outlook-max-attachment" name="maxAttachmentMb" type="number" min="1" step="1" autocomplete="off" />
              </div>
            </div>
            <div class="input-group">
              <label for="outlook-mime-types">Allowed MIME types</label>
              <input id="outlook-mime-types" name="allowedMimeTypes" type="text" placeholder="application/pdf,image/png,image/jpeg" autocomplete="off" />
              <span>Comma-separated list. Attachments with other types are skipped.</span>
            </div>
            <label class="checkbox-group">
              <input id="outlook-enabled" name="enabled" type="checkbox" />
              <span>Enable automatic imports from this folder</span>
            </label>
            <div class="outlook-actions">
              <button type="submit" id="outlook-save" class="primary-button">Save Outlook settings</button>
              <button type="button" id="outlook-sync-now" class="secondary-button">Sync now</button>
              <button type="button" id="outlook-resync" class="secondary-button">Request full resync</button>
              <button type="button" id="outlook-disconnect" class="danger-button">Disconnect</button>
            </div>
            <input id="outlook-folder-id" name="folderId" type="hidden" />
            <input id="outlook-folder-path" name="folderPath" type="hidden" />
            <input id="outlook-folder-name" name="folderName" type="hidden" />
            <input id="outlook-folder-weburl" name="folderWebUrl" type="hidden" />
            <input id="outlook-folder-parent-id" name="folderParentId" type="hidden" />
          </form>
          <dl class="outlook-status" id="outlook-status" hidden>
            <div>
              <dt>Status</dt>
              <dd id="outlook-status-state">Not connected</dd>
            </div>
            <div>
              <dt>Folder</dt>
              <dd id="outlook-status-folder">—</dd>
            </div>
            <div>
              <dt>Last sync</dt>
              <dd id="outlook-status-last-sync">—</dd>
            </div>
            <div>
              <dt>Last result</dt>
              <dd id="outlook-status-result">—</dd>
            </div>
          </dl>
        </div>
      </section>

      <section id="add-invoices" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Add invoices or bills</h2>
          <p class="panel-summary">Drag and drop files or click the surface below to select multiple invoices at once. Parsed results are routed to the To Review tab.</p>
          <div id="invoice-drop-zone" class="drop-zone" role="button" tabindex="0">
            <input id="invoice-upload-input" class="visually-hidden" type="file" accept=".pdf,.png,.jpg,.jpeg,.heic,.tif,.tiff,.txt,.doc,.docx,.json,.xml" multiple />
            <div class="drop-zone-content">
              <p class="drop-zone-title">Drag and drop files here</p>
              <p class="drop-zone-subtitle">or click to add file(s)</p>
            </div>
          </div>
          <ul id="upload-status-list" class="upload-status-list">
            <li class="empty">No uploads yet.</li>
          </ul>
        </div>
      </section>

      <section id="vendor-settings" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Vendors</h2>
          <div class="panel-toolbar">
            <button id="import-vendor-defaults" type="button" class="secondary-button">Import suggested defaults</button>
          </div>
          <ul id="vendor-list" class="entity-list">
            <li class="empty">Select a company to load vendor details.</li>
          </ul>
        </div>
      </section>

      <section id="account-settings" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Accounts &amp; Categories</h2>
          <ul id="account-list" class="entity-list">
            <li class="empty">Select a company to load account details.</li>
          </ul>
        </div>
      </section>

      <section id="to-review" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>To Review</h2>
          <p class="panel-summary">Invoices awaiting manual checks before export are listed below.</p>
          <div id="review-bulk-actions" class="review-bulk-actions">
            <div class="review-bulk-toolbar" role="group" aria-label="Invoice actions">
              <button type="button" id="review-bulk-preview" class="bulk-action" disabled>Preview</button>
              <button type="button" id="review-bulk-edit" class="bulk-action" disabled>Edit</button>
              <button type="button" id="review-bulk-save" class="bulk-action" disabled>Save</button>
              <button type="button" id="review-bulk-cancel" class="bulk-action" disabled>Cancel</button>
              <button type="button" id="review-bulk-archive" class="bulk-action" disabled>Archive</button>
              <button type="button" id="review-bulk-delete" class="bulk-action destructive" disabled>Delete</button>
            </div>
            <span id="review-selection-count" class="bulk-selection-count" aria-live="polite">No invoices selected.</span>
          </div>
          <div class="table-wrapper">
            <table class="review-table">
              <thead>
                <tr>
                  <th scope="col" class="col-select">
                    <input type="checkbox" id="review-select-all" aria-label="Select all invoices awaiting review" />
                  </th>
                  <th scope="col" class="col-invoice">Invoice</th>
                  <th scope="col" class="col-date">Invoice date</th>
                  <th scope="col" class="col-vendor">Vendor</th>
                  <th scope="col" class="col-account">Account</th>
                  <th scope="col" class="col-tax">Tax code</th>
                  <th scope="col" class="col-amount">Total ex VAT</th>
                  <th scope="col" class="col-amount">VAT</th>
                  <th scope="col" class="col-amount">Grand total</th>
                  <th scope="col" class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody id="review-table-body">
                <tr class="empty-row">
                  <td colspan="10">No invoices pending review.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="archive" class="company-panel" role="tabpanel" hidden>
        <div class="panel-card">
          <h2>Archive</h2>
          <p class="panel-summary">Invoices parsed with Gemini are stored here until they are moved for review or removed.</p>
          <div class="table-wrapper">
            <table class="archive-table">
              <thead>
                <tr>
                  <th scope="col">Invoice</th>
                  <th scope="col">Vendor</th>
                  <th scope="col">Invoice date</th>
                  <th scope="col">Total</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="archive-table-body">
                <tr class="empty-row">
                  <td colspan="5">No archived invoices yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div id="onedrive-browse-modal" class="modal" hidden aria-hidden="true">
    <div class="modal-overlay" data-modal-dismiss></div>
    <div class="modal-window onedrive-browser-window" role="dialog" aria-modal="true" aria-labelledby="onedrive-browse-title">
      <header class="modal-header">
        <h2 id="onedrive-browse-title">Choose OneDrive folder</h2>
        <button type="button" id="onedrive-browse-close" class="icon-button" aria-label="Close folder browser">&times;</button>
      </header>
      <div class="modal-body">
        <div class="onedrive-browser-toolbar">
          <button type="button" id="onedrive-browse-back" class="secondary-button">Back</button>
          <span id="onedrive-browse-path" class="onedrive-browser-path">All drives</span>
        </div>
        <p id="onedrive-browse-warning" class="onedrive-browser-warning" hidden></p>
        <p id="onedrive-browse-status" class="onedrive-browser-status" hidden></p>
        <ul id="onedrive-browse-list" class="onedrive-browser-list" role="listbox"></ul>
      </div>
      <footer class="modal-footer">
        <button type="button" id="onedrive-browse-cancel" class="secondary-button">Cancel</button>
        <button type="button" id="onedrive-browse-confirm" class="primary-button" disabled>Select folder</button>
      </footer>
    </div>
  </div>

  <div id="outlook-browse-modal" class="modal" hidden aria-hidden="true">
    <div class="modal-overlay" data-modal-dismiss></div>
    <div class="modal-window outlook-browser-window" role="dialog" aria-modal="true" aria-labelledby="outlook-browse-title">
      <header class="modal-header">
        <h2 id="outlook-browse-title">Choose Outlook folder</h2>
        <button type="button" id="outlook-browse-close" class="icon-button" aria-label="Close folder browser">&times;</button>
      </header>
      <div class="modal-body">
        <div class="outlook-browser-toolbar">
          <button type="button" id="outlook-browse-back" class="secondary-button">Back</button>
          <span id="outlook-browse-path" class="outlook-browser-path">Mailbox root</span>
        </div>
        <p id="outlook-browse-warning" class="outlook-browser-warning" hidden></p>
        <p id="outlook-browse-status" class="outlook-browser-status" hidden></p>
        <ul id="outlook-browse-list" class="outlook-browser-list" role="listbox"></ul>
      </div>
      <footer class="modal-footer">
        <button type="button" id="outlook-browse-cancel" class="secondary-button">Cancel</button>
        <button type="button" id="outlook-browse-confirm" class="primary-button" disabled>Select folder</button>
      </footer>
    </div>
  </div>

  <div id="qb-preview-modal" class="modal" hidden aria-hidden="true">
    <div class="modal-overlay" data-modal-dismiss></div>
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="qb-preview-title">
      <header class="modal-header">
        <h2 id="qb-preview-title">QuickBooks Preview</h2>
        <button type="button" id="qb-preview-dismiss" class="icon-button" aria-label="Close preview">&times;</button>
      </header>
      <div class="modal-body">
        <div class="modal-meta">
          <span id="qb-preview-method" class="modal-method">—</span>
        </div>
        <div id="qb-preview-summary" class="preview-summary" hidden></div>
        <pre class="code-block"><code id="qb-preview-json"></code></pre>
      </div>
      <footer class="modal-footer">
        <button type="button" id="qb-preview-copy" class="secondary-button">Copy JSON</button>
        <button type="button" id="qb-preview-close" class="primary-button">Close</button>
      </footer>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with UMD -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="app.js?v=20241216" defer></script>
</body>
</html>
